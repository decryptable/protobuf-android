name: Protobuf Android

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  build:
    runs-on: windows-latest
    steps:
      # Checkout repository including submodules
      - name: Checkout Protobuf repository including submodules
        uses: actions/checkout@v3
        with:
          repository: protocolbuffers/protobuf
          path: protobuf
          submodules: true

      # Set up NDK
      - name: Set up NDK
        id: setup
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: "r27c"
          local-cache: true
        continue-on-error: false

      # Build the Protobuf for Android
      - name: Build Protobuf
        working-directory: "$(pwd)/protobuf"
        run: |
          # Set up the NDK and Protobuf source paths correctly
          ls
          iex (iwr -Uri "https://raw.githubusercontent.com/decryptable/protobuf-android/refs/heads/main/Build.ps1" -UseBasicParsing).Content; BuildProtobuf -protobufSourcePath $(pwd)
        env:
          ANDROID_NDK: ${{ steps.setup.outputs.ndk-path }}

      # Upload to GitHub Release
      - name: Upload Protobuf Android build to GitHub Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: $PWD/protobuf_android-*.zip
          asset_name: protobuf_android-${{ github.run_id }}.zip
          asset_content_type: application/zip
